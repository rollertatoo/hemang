var FigureLightbox={};!function(i){(FigureLightbox={lbContainerSelector:"#figure-lightbox-container",lbSelector:"#figure-lightbox",lbTemplateSelector:"#figure-lightbox-template",contextTemplateSelector:"#image-context-template",lbCloseButtonSelector:"#figure-lightbox .lb-close",zoomRangeSelector:"#figure-lightbox .range-slider",$panZoomEl:null,imgData:null,maxPanzoomScale:200,imgPath:WombatConfig.figurePath||"IMG_PATH_NOT_LOADED"}).insertLightboxTemplate=function(){var t=this.fetchArticleData(),e=_.template(i(this.lbTemplateSelector).html());i(this.lbContainerSelector).append(e(t))},FigureLightbox.fetchArticleData=function(){var t=i(".article");return{doi:this.imgData.doi,strippedDoi:this.imgData.strippedDoi,articleTitle:t.find("#artTitle").text(),authorList:t.find(".author-name").text(),figureList:this.imgList}},FigureLightbox.fetchImageData=function(){return{doi:this.imgData.doi,strippedDoi:this.imgData.strippedDoi,title:this.imgData.imgElement.find(".figcaption").html(),description:this.imgData.imgElement.find(".caption_target").nextUntil(".caption_object").map((function(t,e){return i(e).html()})).toArray().join("\n"),fileSizes:{original:this.imgData.imgElement.find('.file-size[data-size="original"]').text(),large:this.imgData.imgElement.find('.file-size[data-size="large"]').text()}}},FigureLightbox.bindBehavior=function(){var t=this;i(document).on("keyup.figure-lightbox",(function(e){if(i(t.lbSelector).hasClass("open")){switch(e.which){case 27:t.close();break;case 37:case 38:t.prevImage();break;case 39:case 40:t.nextImage();break;default:return}e.preventDefault()}})),i(this.lbContainerSelector).data("is-inited",!0).find(this.lbCloseButtonSelector).on("click",(function(){t.close()})).end().find(".change-img").on("click",(function(){t.switchImage(this.getAttribute("data-doi"))})).end().find(".all-fig-btn").on("click",(function(){var t=i("#figures-list");t.hasClass("figures-list-open")?t.removeClass("figures-list-open"):t.addClass("figures-list-open")})).end().find("#figures-list").on("mousewheel",(function(i){i.stopPropagation()})).end().find("#image-context").on("click","a.target_link",(function(){target=i(this).attr("href"),t.close()})).end().find("#image-context").on("click",".show-context",(function(){t.close()})).end().find(".next-fig-btn:not(.fig-btn-disabled)").on("click",(function(){return t.nextImage()})).end().find(".prev-fig-btn:not(.fig-btn-disabled)").on("click",(function(){return t.prevImage()})).end().find("#image-context").on("click","#view-more, #view-less",(function(){t.toggleDescription()})).end().find(".reset-zoom-btn").on("click",(function(){return t.resetZoom()})).end().find("#lb-zoom-min").on("click",(function(){t.zoomOut()})).end().find("#lb-zoom-max").on("click",(function(){t.zoomIn()})).end().on("image-switch.lightbox",(function(e,o){var n=i(t.lbSelector).find(".fig-btn").show();0===o.index?n.filter(".prev-fig-btn").addClass("fig-btn-disabled"):n.filter(".prev-fig-btn").removeClass("fig-btn-disabled"),o.index===t.imgList.length-1?n.filter(".next-fig-btn").addClass("fig-btn-disabled"):n.filter(".next-fig-btn").removeClass("fig-btn-disabled"),t.truncateDescription()}))},FigureLightbox.nextImage=function(){var i=this.getCurrentImageIndex()+1,t=this.imgList[i];if(!t)return!1;this.scrollDrawerToIndex(i),this.switchImage(t.getAttribute("data-doi"))},FigureLightbox.prevImage=function(){var i=this.getCurrentImageIndex()-1,t=this.imgList[i];if(!t)return!1;this.scrollDrawerToIndex(i),this.switchImage(t.getAttribute("data-doi"))},FigureLightbox.scrollDrawerToIndex=function(t){var e=i(this.lbSelector+" #figures-list"),o=e.find(".change-img:eq("+t+")").position().top;e.hasClass("figures-list-open")&&e.scrollTop(e.scrollTop()+o)},FigureLightbox.getCurrentImageIndex=function(){var i=this,t=null;return this.imgList.each((function(e,o){if(o.getAttribute("data-doi")===i.imgData.strippedDoi)return t=e,!1})),t},FigureLightbox.switchImage=function(t,e){var o={descriptionExpanded:this.descriptionExpanded||!1};e=i.extend(o,e),this.imgData={doi:t},this.imgData.strippedDoi=this.imgData.doi.replace(/^info:doi\//,"");var n=this.getCurrentImageIndex();this.imgData.imgElement=i(this.imgList[n]),i(this.lbSelector+" #figures-list").find(".change-img-active").removeClass("change-img-active").end().find(".change-img:eq("+n+")").addClass("change-img-active");var a=this.fetchImageData(),r={showInContext:this.showInContext},s=i.extend(a,r,e),l=_.template(i(this.contextTemplateSelector).html());i(this.lbSelector+" #image-context").children().remove().end().append(l(s)).find('#figure-description-wrapper a[href^="#"]').addClass("target_link"),this.descriptionExpanded&&this.retractDescription(),this.renderImg(this.imgData.doi),this.descriptionExpanded||this.truncateDescription(),i(this.lbContainerSelector).trigger("image-switch.lightbox",{index:n,element:this.imgData.imgElement})},FigureLightbox.truncateDescription=function(){i(this.lbSelector+" #view-more-wrapper").dotdotdot({after:"#view-more",watch:!0}).data("is-truncated",!0)},FigureLightbox.toggleDescription=function(){this.descriptionExpanded?this.retractDescription():this.expandDescription()},FigureLightbox.expandDescription=function(){this.descriptionExpanded=!0,i("#view-more-wrapper,#show-context-container, #download-buttons").stop(!0,!0).fadeOut(300,(function(){i("#view-less-wrapper").fadeIn(500),i("#image-context").addClass("full-display")})),this.descriptionExpanded=!0},FigureLightbox.retractDescription=function(){i("#view-less-wrapper").stop(!0,!0).fadeOut(300,(function(){i("#image-context").removeClass("full-display"),i("#view-more-wrapper,#show-context-container, #download-buttons").fadeIn(300),i("#view-less-wrapper").trigger("update")})),this.descriptionExpanded=!1},FigureLightbox.isInited=function(){return i(this.lbContainerSelector).data("is-inited")},FigureLightbox.loadImage=function(t,e,o){i(this.lbContainerSelector).trigger("opened.lightbox"),this.lbContainerSelector=t||this.lbContainerSelector,this.imgData={doi:e},this.imgData.strippedDoi=this.imgData.doi.replace(/^info:doi\//,""),this.isInited()||(this.imgList=i(".figure"),this.insertLightboxTemplate(),this.bindBehavior()),i(this.lbSelector).foundation("reveal","open"),this.switchImage(this.imgData.doi),"function"==typeof o&&o()},FigureLightbox.renderImg=function(t){var e=this;this.showLoader();var o=i(this.lbSelector).find("img.main-lightbox-image").attr("src",this.buildImgUrl(t)).one("load",(function(){e.resetZoom(),e.hideLoader()}));this.panZoom(o),i(document).foundation("slider","reflow")},FigureLightbox.showLoader=function(){i(this.lbSelector).find(".loader").addClass("showing")},FigureLightbox.hideLoader=function(){i(this.lbSelector).find(".loader").removeClass("showing")},FigureLightbox.close=function(){this.destroy(),i(this.lbSelector).foundation("reveal","close"),i(this.lbContainerSelector).trigger("closed.lightbox")},FigureLightbox.showInContext=function(i){return"#"+(i=(i=i.split("/"))[1].slice(8)).replace(/\./g,"-")},FigureLightbox.panZoom=function(t){var e=this;this.$panZoomEl=t.panzoom({contain:!1,minScale:1,maxScale:e.maxPanzoomScale/20}),this.bindPanZoomToSlider(),this.bindSliderToPanZoom(),this.$panZoomEl.parent().off("mousewheel").on("mousewheel",(function(t){t.preventDefault(),i(e.lbContainerSelector).trigger("mousewheel-zoom.lightbox",t);var o=t.delta||t.originalEvent.wheelDelta,n=o?o<0:t.originalEvent.deltaY>0;e.zoom(n,t)}))},FigureLightbox.zoomIn=function(){this.zoom(!1)},FigureLightbox.zoomOut=function(){this.zoom(!0)},FigureLightbox.resetZoom=function(){this.$panZoomEl.panzoom("reset",!1)},FigureLightbox.calculateViewportDimensions=function(){var t=i(this.lbSelector).find(".img-container").height(),e=i(this.lbSelector).find("#lightbox-footer").height(),o=i(this.lbSelector).find(".lb-header").height();return{width:i(this.lbSelector).find(".img-container").width(),height:t-o-e}},FigureLightbox.calculateFocalPoint=function(){var t=i(this.lbSelector).find(".img-container");return{clientX:t.width()/2,clientY:t.height()/2}},FigureLightbox.zoom=function(i){i=i||!1;var t=this.calculateFocalPoint();this.$panZoomEl.panzoom("zoom",i,{increment:.05,animate:!1,focal:t})},FigureLightbox.calculateImageInitialPosition=function(){var i=this.calculateViewportDimensions(),t=this.$panZoomEl.height(),e=this.$panZoomEl.width(),o=(i.height-t)/2,n=(i.width-e)/2,a=this.$panZoomEl.panzoom("instance"),r=a.getMatrix();r[4]=n,r[5]=o,a.setMatrix(r)},FigureLightbox.bindPanZoomToSlider=function(){var t=this,e=t.$panZoomEl.panzoom("instance");i(this.zoomRangeSelector).off("change.fndtn.slider").on("change.fndtn.slider",(function(){var o=e.getMatrix(),n=parseFloat(this.getAttribute("data-slider")/20);if(o[0]!==n||o[3]!==n){i(t.lbContainerSelector).trigger("slider-zoom.lightbox");var a=!1,r=0,s=t.calculateFocalPoint();n>o[3]?r=n-o[3]:(a=!0,r=o[3]-n),t.$panZoomEl.panzoom("zoom",a,{increment:r,animate:!1,focal:s})}}))},FigureLightbox.bindSliderToPanZoom=function(){var t=this;this.$panZoomEl.off("panzoomzoom").on("panzoomzoom",(function(e,o,n){i(t.zoomRangeSelector).foundation("slider","set_value",20*n),t.bindPanZoomToSlider()})),this.$panZoomEl.off("panzoomreset").on("panzoomreset",(function(e){i(t.zoomRangeSelector).foundation("slider","set_value",20),t.bindPanZoomToSlider(),t.calculateImageInitialPosition()}))},FigureLightbox.buildImgUrl=function(i,t){var e={path:this.imgPath,size:"large"},o=-1===(t=_.extend(e,t)).path.indexOf("?")?"?size=":"&size=";return t.path+o+t.size+"&id="+i},FigureLightbox.destroy=function(){}}(jQuery);